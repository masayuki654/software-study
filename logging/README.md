# Logging

## Logging とは？

コマンドの実行履歴、エラー、ユーザー操作履歴など、何かのイベントごとに出力される履歴のこと。

### なぜ必要か？

- ログ解析でサービス品質の向上につながる対策を考えられる
- セキュリティの監視に役立つ
- エラーが発生した際にどこで生じているか？どうすれば対策が打てるか？の手がかりとなる。
- ログレベル(後述)を設定することで、緊急対応が必要なエラーを開発者に通知することができる。

### ログレベル

一般的なログレベル。システムやアプリケーションによって定義が異なることもある。
| ログレベル | 説明 |
| :-------- | :--- |
| CRITICAL | 致命的なエラーメッセージ。アプリケーションのクラッシュや重大な障害が発生したことを示す。|
| ERROR | エラーメッセージ。重大な問題が発生し、処理が継続できない可能性がある。|
| WARNING | 警告メッセージ。予期しないが重大ではない問題や異常状態を示す。|
| INFO | 一般的な情報メッセージ。処理の進行状況や重要なイベントを示す。|
| DEBUG | デバッグ目的の詳細な情報。通常、本番環境では無効にされる。|

## Log の流れ(例)

0. ログ設計：どのログをどのレベルで、どこに、どういうフォーマットで出力するか？
1. ログ収集：各言語のライブラリを使ってログを収集する。Python だと logging ライブラリを使う。ログはファイルや標準出力などに出力するか、ログ収集エージェント(ログデータを収集し、収集サーバや管理 PF に送信するツール)を介して、サーバや管理 PF に送信する。
2. ログ収集サーバ：ログを受け取り、保持する。Elasticsearch, Fluentd など。
3. ログストレージ：収集サーバがログを保持するためのストレージ。Elasticsearch, Amazon S3 など。
4. 可視化ツール：ログをダッシュボード形式で可視化する。Kibana, Grafana など。

## 各言語の Logging ライブラリ

| 言語   | ライブラリ, ツール例         | ref                                                                                        |
| :----- | :--------------------------- | :----------------------------------------------------------------------------------------- |
| React  | loglevel, sentry(エラー監視) | https://github.com/pimterry/loglevel https://zenn.dev/mima_ita/articles/8f820971e73d1f     |
| Python | logging                      | https://docs.python.org/3/library/logging.html                                             |
| Golang | logrus, zap                  | https://github.com/avelino/awesome-go#logging (サードパーティ製のライブラリがたくさんある) |

### ライブラリを使うメリット

print とか console.log でいいじゃんとなるかもしれないが、以下のメリットがある。

- ログレベルの制御 → 本番環境では大事なログだけ表示する
- ログのフォーマットと構造化 → 解析しやすくなる
- ログの保存
- エラートラッキングとモニタリング
- ログのフィルタリング、検索

## Python の logging ライブラリを使ってログを出力する

### 登場人物

| 名称          | 説明                                                                                                                                                         |
| :------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| logging       | logging ライブラリの本体。このライブラリで定義されているクラスやら関数やらを使ってログを設定する。                                                           |
| getLogger     | ロガーオブジェクトを取得するための関数。ロガーオブジェクトはログの出力先やフォーマット、ログレベルなどの設定情報をもち、ログメッセージを処理するオブジェクト |
| FileHandler   | ログメッセージをファイルに出力するためのハンドラ(ログの出力方法や形式を設定するもの), クラス                                                                 |
| StreamHandler | ログメッセージを標準出力に出力するためのハンドラ, クラス                                                                                                     |
| Formatter     | ログメッセージのフォーマットを定義するためのクラス                                                                                                           |

### 基本的な設定の流れ

1. logger を設定する
2. formatter を設定する
3. handler を設定する(ログレベル, フォーマットなど)
4. logger にハンドラを追加する
5. 出力する

### 設定ファイルを使ったログの設定

logging 用の conf ファイルを用意し、config.fileConfig で設定を読み込むと、コード上でログの設定をせずに済む。
